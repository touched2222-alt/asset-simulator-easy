import streamlit as st
import pandas as pd
import plotly.express as px
import json
import os

# --- è¨­å®šä¿å­˜ç”¨ãƒ•ã‚¡ã‚¤ãƒ«å ---
CONFIG_FILE = "asset_config.json"

# --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤ ---
DEFAULT_CONFIG = {
    "current_age": 48, "end_age": 100,
    "r_cash": 1.0, "r_401k": 5.0, "r_nisa": 5.0, "r_paypay": 6.0, "inflation": 2.0,
    "ini_cash": 500, "ini_401k": 500, "ini_nisa": 100, "ini_paypay": 10,
    "age_work_last": 65,
    "inc_20s": 300, "inc_30s": 400, "inc_40s": 500, "inc_50s": 600, "inc_60s": 400,
    "age_401k_get": 65, "tax_401k": 12.0, "age_pension": 70, "pension_monthly": 200000,
    "cost_base": 30,
    "exp_20s": 0, "exp_30s": 50, "exp_40s": 100, "exp_50s": 150, "exp_60s": 50,
    "nisa_monthly": 20000, "k401_monthly": 55000, "paypay_monthly": 300,
    "dam_1": 700, "dam_2": 500, "dam_3": 300,
    "inc1_a": 55, "inc1_v": 500, "inc2_a": 0, "inc2_v": 0, "inc3_a": 0, "inc3_v": 0,
    "dec1_a": 66, "dec1_v": 400, "dec2_a": 0, "dec2_v": 0, "dec3_a": 0, "dec3_v": 0
}

def load_settings():
    config = DEFAULT_CONFIG.copy()
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, "r", encoding="utf-8") as f:
                saved_config = json.load(f)
                config.update(saved_config)
        except Exception as e:
            st.error(f"è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
    for key, value in config.items():
        if key not in st.session_state:
            st.session_state[key] = value

def save_settings():
    save_data = {}
    for key in DEFAULT_CONFIG.keys():
        if key in st.session_state:
            save_data[key] = st.session_state[key]
    try:
        with open(CONFIG_FILE, "w", encoding="utf-8") as f:
            json.dump(save_data, f, indent=4, ensure_ascii=False)
        st.sidebar.success(f"âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼")
    except Exception as e:
        st.sidebar.error(f"ä¿å­˜å¤±æ•—: {e}")

st.set_page_config(page_title="ç°¡æ˜“è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿", page_icon="ğŸ’°", layout="wide")

def main():
    if "first_load_done" not in st.session_state:
        load_settings()
        st.session_state["first_load_done"] = True

    st.title("ğŸ’° ç°¡æ˜“è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿Î²")
    st.caption("Ver. Replenish Limit (Under 65)")

    # --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
    st.sidebar.header("âš™ï¸ è¨­å®šãƒ‘ãƒãƒ«")
    if st.sidebar.button("ğŸ’¾ è¨­å®šã‚’ä¿å­˜ (Save)"):
        save_settings()

    tab1, tab2, tab3, tab4, tab5, tab6 = st.sidebar.tabs(["åŸºæœ¬", "åˆæœŸ", "åå…¥", "æ”¯å‡º", "è²¯è“„è¨­å®š", "è‡¨æ™‚"])

    with tab1:
        st.subheader("åŸºæœ¬æƒ…å ±")
        current_age = st.number_input("ç¾åœ¨å¹´é½¢", 20, 80, key="current_age")
        end_age = st.number_input("çµ‚äº†å¹´é½¢", 80, 120, key="end_age")
        st.markdown("---")
        st.subheader("é‹ç”¨åˆ©å›ã‚Š (%)")
        r_cash = st.number_input("è²¯è“„é‡‘åˆ©", 0.0, 10.0, step=0.1, format="%.2f", key="r_cash") / 100
        r_401k = st.number_input("401kå¹´åˆ©", 0.0, 30.0, step=0.1, format="%.2f", key="r_401k") / 100
        r_nisa = st.number_input("æ–°NISAå¹´åˆ©", 0.0, 30.0, step=0.1, format="%.2f", key="r_nisa") / 100
        r_paypay = st.number_input("ä»–é‹ç”¨å¹´åˆ©", 0.0, 50.0, step=0.1, format="%.2f", key="r_paypay") / 100
        inflation = st.number_input("ã‚¤ãƒ³ãƒ•ãƒ¬ç‡", -5.0, 20.0, step=0.1, format="%.2f", key="inflation") / 100

    with tab2:
        st.subheader("ç¾åœ¨ã®è³‡ç”£ (ä¸‡å††)")
        ini_cash = st.number_input("è²¯è“„", 0, 10000, step=10, key="ini_cash") * 10000
        ini_401k = st.number_input("401k", 0, 10000, step=10, key="ini_401k") * 10000
        ini_nisa = st.number_input("æ–°NISA", 0, 10000, step=10, key="ini_nisa") * 10000
        ini_paypay = st.number_input("ä»–é‹ç”¨", 0, 10000, step=10, key="ini_paypay") * 10000

    with tab3:
        st.subheader("åƒãæ–¹")
        age_work_last = st.number_input("ä½•æ­³ã¾ã§åƒãï¼Ÿ", 50, 90, key="age_work_last")
        st.subheader("çµ¦ä¸åå…¥ (æ‰‹å–ã‚Šå¹´åãƒ»ä¸‡å††)")
        inc_20s = st.number_input("20ä»£ å¹´å", 0, 5000, step=10, key="inc_20s") * 10000
        inc_30s = st.number_input("30ä»£ å¹´å", 0, 5000, step=10, key="inc_30s") * 10000
        inc_40s = st.number_input("40ä»£ å¹´å", 0, 5000, step=10, key="inc_40s") * 10000
        inc_50s = st.number_input("50ä»£ å¹´å", 0, 5000, step=10, key="inc_50s") * 10000
        inc_60s = st.number_input("60ä»£ä»¥é™ å¹´å", 0, 5000, step=10, key="inc_60s") * 10000
        st.markdown("---")
        st.subheader("å¹´é‡‘ãƒ»é€€è·é‡‘")
        age_401k_get = st.number_input("401kå—å–å¹´é½¢", 50, 80, key="age_401k_get")
        tax_401k = st.number_input("401kå—å–ç¨ç‡(%)", 0.0, 50.0, step=0.1, format="%.1f", key="tax_401k") / 100
        c1, c2 = st.columns(2)
        with c1: age_pension = st.number_input("å¹´é‡‘é–‹å§‹å¹´é½¢", 60, 75, key="age_pension")
        with c2: pension_monthly = st.number_input("å¹´é‡‘æœˆé¡(å††)", 0, 500000, step=10000, key="pension_monthly")

    with tab4:
        st.subheader("1. åŸºæœ¬ç”Ÿæ´»è²»")
        cost_base = st.number_input("åŸºæœ¬ç”Ÿæ´»è²»(æœˆ/ä¸‡å††)", 0, 200, key="cost_base") * 10000
        st.subheader("2. å¹´é–“ç‰¹åˆ¥æ”¯å‡º (ä¸‡å††/å¹´)")
        exp_20s = st.number_input("20ä»£ ç‰¹åˆ¥å‡ºè²»", 0, 5000, step=10, key="exp_20s") * 10000
        exp_30s = st.number_input("30ä»£ ç‰¹åˆ¥å‡ºè²»", 0, 5000, step=10, key="exp_30s") * 10000
        exp_40s = st.number_input("40ä»£ ç‰¹åˆ¥å‡ºè²»", 0, 5000, step=10, key="exp_40s") * 10000
        exp_50s = st.number_input("50ä»£ ç‰¹åˆ¥å‡ºè²»", 0, 5000, step=10, key="exp_50s") * 10000
        exp_60s = st.number_input("60ä»£ ç‰¹åˆ¥å‡ºè²»", 0, 5000, step=10, key="exp_60s") * 10000
        st.markdown("---")
        st.subheader("3. ç©ç«‹æŠ•è³‡ (çµ¦ä¸å¤©å¼•ã)")
        col_t1, col_t2, col_t3 = st.columns(3)
        with col_t1: nisa_monthly = st.number_input("NISAç©ç«‹(æœˆ/å††)", 0, 500000, step=1000, key="nisa_monthly")
        with col_t2: k401_monthly = st.number_input("401kç©ç«‹(æœˆ/å††)", 0, 500000, step=1000, key="k401_monthly")
        with col_t3: paypay_monthly = st.number_input("ä»–é‹ç”¨ç©ç«‹(æœˆ/å††)", 0, 500000, step=1000, key="paypay_monthly")

    with tab5:
        st.subheader("æœ€ä½è²¯è“„é¡ (æŠ•è³‡é–‹å§‹ãƒ»ç¶­æŒãƒ©ã‚¤ãƒ³)")
        st.info("""
        **ã€ãƒ«ãƒ¼ãƒ«ã€‘**
        1. **ä½™å‰°è³‡é‡‘ã®æŠ•è³‡**: ç¾é‡‘ãŒã“ã®è¨­å®šé¡ã‚’è¶…ãˆãŸã‚‰ã€è¶…ãˆãŸåˆ†ã‚’NISAã«æŠ•è³‡ã—ã¾ã™ï¼ˆå…¨å¹´é½¢ï¼‰ã€‚
        2. **ä¸è¶³åˆ†ã®è£œå¡«**: ç¾é‡‘ãŒã“ã®è¨­å®šé¡ã‚’ä¸‹å›ã£ãŸå ´åˆã€
           - **65æ­³ã¾ã§**: NISAã‚’å£²å´ã—ã¦ã€è¨­å®šé¡ã«æˆ»ã‚‹ã‚ˆã†è£œå¡«ã—ã¾ã™ã€‚
           - **66æ­³ä»¥é™**: è¨­å®šé¡ã‚’ä¸‹å›ã£ã¦ã‚‚è£œå¡«ã—ã¾ã›ã‚“ï¼ˆãŸã ã—å€Ÿé‡‘ã«ãªã‚‹å ´åˆã¯è£œå¡«ã—ã¾ã™ï¼‰ã€‚
        """)
        dam_1 = st.number_input("ã€œ49æ­³ (ä¸‡å††)", 0, 10000, step=50, key="dam_1") * 10000
        dam_2 = st.number_input("50ä»£ (ä¸‡å††)", 0, 10000, step=50, key="dam_2") * 10000
        dam_3 = st.number_input("60æ­³ã€œ (ä¸‡å††)", 0, 10000, step=50, key="dam_3") * 10000

    with tab6:
        st.subheader("ğŸ’° è‡¨æ™‚åå…¥ (3æ )")
        c_i1_a, c_i1_v = st.columns([1, 2])
        inc1_age = c_i1_a.number_input("åå…¥â‘  å¹´é½¢", 0, 100, key="inc1_a")
        inc1_val = c_i1_v.number_input("åå…¥â‘  é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="inc1_v") * 10000
        c_i2_a, c_i2_v = st.columns([1, 2])
        inc2_age = c_i2_a.number_input("åå…¥â‘¡ å¹´é½¢", 0, 100, key="inc2_a")
        inc2_val = c_i2_v.number_input("åå…¥â‘¡ é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="inc2_v") * 10000
        c_i3_a, c_i3_v = st.columns([1, 2])
        inc3_age = c_i3_a.number_input("åå…¥â‘¢ å¹´é½¢", 0, 100, key="inc3_a")
        inc3_val = c_i3_v.number_input("åå…¥â‘¢ é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="inc3_v") * 10000
        st.markdown("---")
        st.subheader("ğŸ’¸ è‡¨æ™‚æ”¯å‡º (3æ )")
        c_d1_a, c_d1_v = st.columns([1, 2])
        dec1_age = c_d1_a.number_input("æ”¯å‡ºâ‘  å¹´é½¢", 0, 100, key="dec1_a")
        dec1_val = c_d1_v.number_input("æ”¯å‡ºâ‘  é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="dec1_v") * 10000
        c_d2_a, c_d2_v = st.columns([1, 2])
        dec2_age = c_d2_a.number_input("æ”¯å‡ºâ‘¡ å¹´é½¢", 0, 100, key="dec2_a")
        dec2_val = c_d2_v.number_input("æ”¯å‡ºâ‘¡ é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="dec2_v") * 10000
        c_d3_a, c_d3_v = st.columns([1, 2])
        dec3_age = c_d3_a.number_input("æ”¯å‡ºâ‘¢ å¹´é½¢", 0, 100, key="dec3_a")
        dec3_val = c_d3_v.number_input("æ”¯å‡ºâ‘¢ é‡‘é¡(ä¸‡)", 0, 10000, step=100, key="dec3_v") * 10000

    # --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    records = []
    cash = ini_cash
    k401 = ini_401k
    nisa = ini_nisa
    paypay = ini_paypay
    nisa_used = ini_nisa

    records.append({
        "Age": current_age, "Total": int(cash + k401 + nisa + paypay),
        "Cash": int(cash), "401k": int(k401), "NISA": int(nisa), "Other": int(paypay)
    })

    for age in range(current_age + 1, end_age + 1):
        # A. é‹ç”¨
        prev_cash = cash
        cash = prev_cash * (1 + r_cash)
        nisa *= (1 + r_nisa)
        paypay *= (1 + r_paypay)
        if age < age_401k_get: k401 *= (1 + r_401k)

        # B. åå…¥ã¨ç©ç«‹
        is_working = (age <= age_work_last)
        salary = 0
        annual_extra_exp = 0
        if is_working:
            if age < 30: salary = inc_20s; annual_extra_exp = exp_20s
            elif age < 40: salary = inc_30s; annual_extra_exp = exp_30s
            elif age < 50: salary = inc_40s; annual_extra_exp = exp_40s
            elif age < 60: salary = inc_50s; annual_extra_exp = exp_50s
            else: salary = inc_60s; annual_extra_exp = exp_60s
        pension = pension_monthly * 12 if age >= age_pension else 0

        # C. æ”¯å‡º
        if age > age_work_last:
            cost = cost_base * 12 * ((1 + inflation) ** (age - (age_work_last + 1)))
        else:
            cost = cost_base * 12
        
        k401_add = k401_monthly * 12 if is_working else 0
        nisa_add = nisa_monthly * 12 if is_working else 0
        paypay_add = paypay_monthly * 12 if is_working else 0

        # D. è³‡ç”£æ›´æ–°
        if is_working and age < age_401k_get: k401 += k401_add
        if age == age_401k_get:
            income_401k = k401 * (1 - tax_401k)
            cash += income_401k
            k401 = 0
        elif age > age_401k_get: k401 = 0

        nisa += nisa_add
        nisa_used += nisa_add
        if is_working: paypay += paypay_add
        else: paypay -= min(paypay, 200000)

        inc_tmp = 0
        if age == inc1_age: inc_tmp += inc1_val
        if age == inc2_age: inc_tmp += inc2_val
        if age == inc3_age: inc_tmp += inc3_val
        dec_tmp = 0
        if age == dec1_age: dec_tmp += dec1_val
        if age == dec2_age: dec_tmp += dec2_val
        if age == dec3_age: dec_tmp += dec3_val

        cash_flow = salary + pension + inc_tmp - cost - annual_extra_exp - dec_tmp - k401_add - nisa_add - paypay_add
        cash += cash_flow

        # E. ãƒ€ãƒ åˆ¶å¾¡
        if age < 50: target = dam_1
        elif age < 60: target = dam_2
        else: target = dam_3

        diff = cash - target

        if diff > 0:
            # ä½™å‰° -> NISAã¸
            surplus = diff
            limit_year = max(0, 3600000 - nisa_add)
            limit_life = max(0, 18000000 - nisa_used)
            move = min(surplus, limit_year, limit_life)
            cash -= move
            nisa += move
            nisa_used += move
        elif diff < 0:
            # ä¸è¶³ -> NISAã‹ã‚‰è£œå¡« (65æ­³ã¾ã§)
            if age <= 65:
                shortage = abs(diff)
                restore = min(shortage, nisa)
                nisa -= restore
                cash += restore
            else:
                # 66æ­³ä»¥é™ã¯å€Ÿé‡‘(ãƒã‚¤ãƒŠã‚¹)æ™‚ã®ã¿è£œå¡«
                if cash < 0:
                    shortage = abs(cash)
                    restore = min(shortage, nisa)
                    nisa -= restore
                    cash += restore

        records.append({
            "Age": age, "Total": int(cash + k401 + nisa + paypay),
            "Cash": int(cash), "401k": int(k401), "NISA": int(nisa), "Other": int(paypay)
        })

    # --- çµæœè¡¨ç¤º ---
    df = pd.DataFrame(records)
    st.markdown("### ğŸ” æ™‚ç‚¹ãƒã‚§ãƒƒã‚¯")
    target_age = st.slider("ä½•æ­³æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¾ã™ã‹ï¼Ÿ", current_age, end_age, 65)
    try:
        target_row = df[df["Age"] == target_age].iloc[0]
        c1, c2, c3, c4, c5 = st.columns(5)
        c1.metric(f"{target_age}æ­³ã®ç·è³‡ç”£", f"{target_row['Total']/10000:,.0f}ä¸‡å††")
        c2.metric("ã†ã¡ç¾é‡‘", f"{target_row['Cash']/10000:,.0f}ä¸‡å††")
        c3.metric("ã†ã¡401k", f"{target_row['401k']/10000:,.0f}ä¸‡å††")
        c4.metric("ã†ã¡æ–°NISA", f"{target_row['NISA']/10000:,.0f}ä¸‡å††")
        c5.metric("ã†ã¡ä»–é‹ç”¨", f"{target_row['Other']/10000:,.0f}ä¸‡å††")
    except: st.error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")

    st.markdown("---")
    st.markdown("### ğŸ“ˆ è³‡ç”£æ¨ç§»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
    graph_type = st.radio("ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—", ["ç©ã¿ä¸Šã’ (ç·è³‡ç”£)", "æŠ˜ã‚Œç·š (å€‹åˆ¥æ¨ç§»)"], horizontal=True)
    df_melt = df.melt(id_vars=["Age"], value_vars=["Cash", "401k", "NISA", "Other"], var_name="Asset", value_name="Amount")
    colors = {"Cash": "#636EFA", "NISA": "#EF553B", "401k": "#00CC96", "Other": "#AB63FA"}
    if graph_type == "ç©ã¿ä¸Šã’ (ç·è³‡ç”£)":
        fig = px.area(df_melt, x="Age", y="Amount", color="Asset", labels={"Amount": "é‡‘é¡ (å††)", "Age": "å¹´é½¢"}, color_discrete_map=colors)
    else:
        fig = px.line(df_melt, x="Age", y="Amount", color="Asset", labels={"Amount": "é‡‘é¡ (å††)", "Age": "å¹´é½¢"}, color_discrete_map=colors)
    fig.update_layout(hovermode="x unified")
    st.plotly_chart(fig, use_container_width=True)
    with st.expander("ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«"):
        st.dataframe(df)

if __name__ == '__main__':
    main()